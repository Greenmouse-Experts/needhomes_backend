// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum AccountType {
  INDIVIDUAL
  CORPORATE
  PARTNER
}

enum AccountStatus {
  PENDING
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum PartnerType {
  REAL_ESTATE_AGENT
  PROPERTY_DEVELOPER
  AGENCY
  OTHER
}

enum AccountVerificationStatus {
  PENDING
  VERIFIED
}

enum AccountVerificationDocumentStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum VerificationType {
  INDIVIDUAL
  CORPORATE
  PARTNER
}

enum InvestmentModel {
  OUTRIGHT_PURCHASE
  CO_DEVELOPMENT
  FRACTIONAL_OWNERSHIP
  LAND_BANKING
  SAVE_TO_OWN
}

enum PropertyType {
  RESIDENTIAL
  COMMERCIAL
  LAND
}

enum DevelopmentStage {
  PLANNING
  ONGOING
  COMPLETED
}

enum exitWindow {
  MONTHLY
  QUATERLY
  ANNUALLY
  AT_MATURITY
}

enum PaymentOption {
  FULL_PAYMENT
  INSTALLMENT
}

//enums for codevelopment property fields
enum ExitRule {
  ANYTIME
  AFTER_LOCK_IN_PERIOD
  AFTER_PROJECT_COMPLETION
  AT_EXIT_WINDOW_ONLY
  NOT_ALLOWED
}

enum PlanType {
  FREE
  BASIC
  PREMIUM
}



model SubscriptionPlan {
  id        String   @id @default(cuid())

  // ---- Plan Info ----
  name      String              // e.g. "Free Plan", "Basic Plan"
  type      PlanType

  description String?

  // ---- Pricing ----
  price     Int?                // stored in kobo (₦) — null for free plan
  validity  Int                 // number of days (e.g. 30 for monthly)

  // ---- Benefits ----
  canViewPremiumProperty Boolean @default(false)
  maxInvestments         Int?     // null = unlimited

  // ---- Status ----
  isActive  Boolean  @default(true)

  // ---- Timestamps ----
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type])
}




model User {
  id                          String                    @id @default(uuid())
  profilePicture              String?
  firstName                   String? // Optional for CORPORATE accounts
  lastName                    String? // Optional for CORPORATE accounts
  email                       String                    @unique
  phone                       String                    @unique
  password                    String
  isEmailVerified             Boolean                   @default(false)
  accountType                 AccountType
  companyName                 String? // Required for CORPORATE accounts
  account_status              AccountStatus             @default(ACTIVE)
  account_verification_status AccountVerificationStatus @default(PENDING)
  referral_source             String?
  // Partner-specific fields (nullable, used when accountType=PARTNER)
  partnerType                 PartnerType?
  referralCode                String?                   @unique
  totalReferrals              Int                       @default(0)
  totalCommission             Float                     @default(0)
  createdAt                   DateTime                  @default(now())
  updatedAt                   DateTime                  @updatedAt
  deletedAt                   DateTime?

  // Relations
  verification_document VerificationDocument? @relation("UserVerification")
  bank_account          BankAccount?          @relation("UserBankAccount")
  roles                 UserRole[]
  partnerRoles          PartnerRole[]         @relation("UserAsPartner")
  referrals             Referral[]            @relation("PartnerReferrals")
  referralClicks        ReferralClick[]       @relation("PartnerReferralClicks")

  @@index([email])
  @@index([phone])
  @@index([referralCode])
  @@index([deletedAt])
  @@index([createdAt])
}

model VerificationDocument {
  id               String           @id @default(uuid())
  user_id          String           @unique
  idType           String?
  frontPage        String?
  companyName      String?
  rcNumber         String?
  cacDocument      String?
  backPage         String?
  authorizedId     String?
  authorizedName   String?
  utilityBill      String?
  address          String?
  verificationType VerificationType
  status           AccountVerificationDocumentStatus @default(PENDING)
  submitedAt       DateTime         @default(now())
  RejectionReason  String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  deletedAt        DateTime?

  user User @relation("UserVerification", fields: [user_id], references: [id])

  @@index([user_id])
  @@index([deletedAt])
}

model Bank {
  id                         Int      @id
  name                       String
  slug                       String?
  code                       String   @unique
  longcode                   String?
  gateway                    String?
  pay_with_bank              Boolean  @default(false)
  supports_transfer          Boolean  @default(false)
  available_for_direct_debit Boolean  @default(false)
  active                     Boolean  @default(true)
  country                    String   @default("Nigeria")
  currency                   String   @default("NGN")
  type                       String?
  is_deleted                 Boolean  @default(false)
  createdAt                  DateTime @default(now())
  updatedAt                  DateTime @updatedAt

  @@index([code])
  @@index([name])
}

model BankAccount {
  id             String    @id @default(uuid())
  user_id        String    @unique
  account_number String
  bank_code      String
  bank_name      String
  account_name   String
  country        String    @default("NG")
  currency       String    @default("NGN")
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  deletedAt      DateTime?

  user User @relation("UserBankAccount", fields: [user_id], references: [id])

  @@index([user_id])
  @@index([deletedAt])
}

model Property {
  id               String           @id @default(uuid())
  propertyTitle    String
  propertyType     PropertyType
  investmentModel  InvestmentModel
  location         String
  description      String
  developmentStage DevelopmentStage
  completionDate   DateTime
  published        Boolean         @default(true)
  premiumProperty  Boolean         @default(false)

  //media & documents
  coverImage    String
  galleryImages String[]
  videos        String?

  //documents (admin upload only)
  certificate        String?
  surveyPlanDocument String?
  brochure           String?
  transferDocument   String?

  //pricing and availability
  basePrice      Int // stored in kobo
  additionalFees AdditionalFee[] // ← relation
  availableUnits Int
  totalPrice     Int

  //fields exclusive to outright purchase 
  paymentOption       PaymentOption?
  installmentDuration Int? //months

  //fields exclusive to codevelopment
  minimumInvestment  Int?
  profitSharingRatio Float?
  projectDuration    Int? // in months
  exitRule           ExitRule?

  //fields exclusive to fractional ownership
  totalShares   Int?
  pricePerShare Int? // stored in kobo
  minimumShares Int?
  exitWindow    exitWindow?

  //fields exclusive to land_banking
  plotSize      Float? // in square meters
  pricePerPlot  Int? // stored in kobo
  holdingPeriod Int? // in months
  buyBackOption Boolean?

  //fields exclusive to save_to_own
  targetPropertyPrice Int? // stored in kobo
  savingsFrequency   String? // e.g. 'MONTHLY', 'QUATERLY'
  savingsDuration    Int? // in months

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AdditionalFee {
  id     String @id @default(uuid())
  label  String
  amount Int // stored in kobo

  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

// ========================================
// RBAC Models
// ========================================

model Role {
  id          String           @id @default(uuid())
  name        String           @unique // USER, PARTNER, ADMIN, SUPER_ADMIN
  description String?
  permissions RolePermission[]
  users       UserRole[]
  partners    PartnerRole[]
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
}

model Permission {
  id          String           @id @default(uuid())
  key         String           @unique // e.g. "user.create_own", "user.delete_all"
  description String?
  roles       RolePermission[]
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
}

// Join table: User <-> Role (Many-to-Many)
model UserRole {
  userId String
  roleId String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  assignedAt DateTime @default(now())

  @@id([userId, roleId])
  @@index([userId])
  @@index([roleId])
}

// Join table: Partner <-> Role (Many-to-Many)
// Note: Partners are now users with accountType=PARTNER
model PartnerRole {
  userId String
  roleId String

  user User @relation("UserAsPartner", fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  assignedAt DateTime @default(now())

  @@id([userId, roleId])
  @@index([userId])
  @@index([roleId])
}

// Join table: Role <-> Permission (Many-to-Many)
model RolePermission {
  roleId       String
  permissionId String

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@id([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
}

// ========================================
// Partner & Referral Models
// ========================================

// Track actual conversions (user signups)
model Referral {
  id           String   @id @default(uuid())
  partnerId    String
  userId       String? // If user signs up through partner link
  referralType String // 'USER_SIGNUP', etc.
  commission   Float    @default(0) // Commission earned from this referral
  status       String   @default("PENDING") // PENDING, COMPLETED, PAID
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  partner User @relation("PartnerReferrals", fields: [partnerId], references: [id], onDelete: Cascade)

  @@index([partnerId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

// Track clicks on partner referral links
model ReferralClick {
  id        String   @id @default(uuid())
  partnerId String
  ipAddress String?
  userAgent String?
  clickedAt DateTime @default(now())

  partner User @relation("PartnerReferralClicks", fields: [partnerId], references: [id], onDelete: Cascade)

  @@index([partnerId])
  @@index([clickedAt])
}
